EAPI=8

# Python 3.12+ is not supported due to the removal of `imp`
PYTHON_COMPAT=( python3_{10..11} )

inherit python-single-r1

DESCRIPTION="Open Source Intelligence gathering tool aimed at reducing the time spent harvesting information from open sources."
HOMEPAGE="https://github.com/lanmaster53/recon-ng"
SRC_URI="https://github.com/lanmaster53/${PN}/archive/refs/tags/v${PV}.tar.gz -> ${P}.tar.gz"

LICENSE="GPL-3.0"
SLOT="0"
KEYWORDS="~amd64 ~x86"
IUSE="web"
REQUIRED_USE="${PYTHON_REQUIRED_USE}"

RDEPEND="
    ${PYTHON_DEPS}
    $( python_gen_cond_dep '
        dev-python/pyyaml[${PYTHON_USEDEP}]
        dev-python/dnspython[${PYTHON_USEDEP}]
        dev-python/lxml[${PYTHON_USEDEP}]
        dev-python/mechanize[${PYTHON_USEDEP}]
        dev-python/requests[${PYTHON_USEDEP}]
        web? (
            dev-python/flask[${PYTHON_USEDEP}]
            dev-python/flask-restful[${PYTHON_USEDEP}]
            dev-python/flasgger[${PYTHON_USEDEP}]
            dev-python/dicttoxml[${PYTHON_USEDEP}]
            dev-python/xlsxwriter[${PYTHON_USEDEP}]
            dev-python/unicodecsv[${PYTHON_USEDEP}]
            dev-python/rq[${PYTHON_USEDEP}]
        )
    ')
"

src_prepare() {
    default
}

src_install() {
    exeinto /usr/bin
    doexe ${FILESDIR}/recon-ng ${FILESDIR}/recon-cli
    if use web; then
        doexe ${FILESDIR}/recon-web
    fi

    python_fix_shebang recon-ng recon-cli
    exeinto /usr/share/${PN}
    doexe recon-ng recon-cli
    if use web; then
        python_fix_shebang recon-web
        doexe recon-web
    fi

    insinto /usr/share/${PN}
    doins -r recon
    doins VERSION
}
